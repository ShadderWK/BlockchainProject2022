<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Gotoubun No Hanayome Shop</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  </head>

  <!-- Css -->

  <style>
    .button {
      display: flex;
      justify-content: center;
    }
  </style>

  <body>
    <div class="container">

        <h1 style="text-align: center; color: #313030;">⭐ ร้านค้าตัวละคร Gotoubun No Hanayome ⭐</h1>
        <div class="grid-container">

        <!--ตัวละครที่ 1-->
        <div class="grid-item">
          <label class="label1" style="color:#008c5b"> Nakano Itsuki (ทั่วไป)</label>
          <img src="Image/Itsuki.jpg" width="200px" alt="Nakano Itsuki" />
          <p>0.000025 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Nakano Itsuki',25000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
   
        </div>

        <!--ตัวละครที่ 2-->
        <div class="grid-item">
          <label class="label1" style="color:#008c5b"> Nakano Yotsuba (ทั่วไป)</label>
          <img src="Image/Yotsuba.jpg" width="200px" alt="Nakano Yotsuba" />
          <p>0.000021 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Nakano Yotsuba',21000000000000)"
            >
              ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 3-->
        <div class="grid-item">
          <label class="label1" style="color:#008c5b"> Nakano Miku (ทั่วไป)</label>
          <img src="Image/Miku.jpg" width="200px" alt="Nakano Miku" />
          <p>0.000015 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Nakano Miku',15000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 4-->
        <div class="grid-item">
          <label class="label1" style="color:#008c5b"> Nakano Nino (ทั่วไป)</label>
          <img src="Image/Nino.jpg" width="200px" alt="Nakano Nino" />
          <p>0.000023 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Nakano Nino',23000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 5-->
        <div class="grid-item">
          <label class="label1" style="color:#008c5b"> Nakano Ichika (ทั่วไป)</label>
          <img src="Image/Ichika.jpg" width="200px" alt="Nakano Ichika" />
          <p>0.000011 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Nakano Ichika',11000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 6-->
        <div class="grid-item">
          <label class="label1" style="color:#87CEEB">• Black Rose Yotsuba (แรร์) •</label>
          <img src="Image/Black_rose_Yotsuba.jpg" width="200px" alt="Black Rose Yotsuba" />
          <p>0.0006 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Black Rose Yotsuba',600000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 7-->
        <div class="grid-item">
          <label class="label1" style="color:#87CEEB">• Butterfly Miku (แรร์) •</label>
          <img src="Image/Butterfly_Miku.jpg" width="200px" alt="Butterfly Miku" />
          <p>0.0005 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Butterfly Miku',500000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 8-->
        <div class="grid-item">
          <label class="label1" style="color:#87CEEB">• Maid Nino (แรร์) •</label>
          <img src="Image/Maid_Nino.jpg" width="200px" alt="Maid Nino" />
          <p>0.0007 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Maid Nino',700000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>

        <!--ตัวละครที่ 9-->
        <div class="grid-item">
          <label class="label1" style="color:#FFD700">ϟ Ultimate Itsuki (ตำนาน) ϟ</label>
          <img src="Image/Ultimate_Itsuki.jpg" width="200px" alt="Ultimate Itsuki" />
          <p>0.005 ETH</p>
          <div class="button">
            <button
              class="btn"
              id="button"
              onclick="btnChoose('Ultimate Itsuki',500000000000000)"
            >
            ♢ BUY ♢
            </button>
          </div>
        </div>
      </div>

          <!-- ตาราง -->
          <h1 style="text-align: center; color: #313030;"> ¤ รายชื่อเจ้าของตัวละครปัจจุบัน ¤</h1>
          <table>
          <tr>
            <th>⌚ เวลา ⌚</th>
            <th>✠ ตัวละคร ✠</th>
            <th>❖ เจ้าของ ❖</th>
          </tr>
          <tr>
            <td id="time1"></td>
            <td id="character1"></td>
            <td id="owner1"></td>
          </tr>
          <tr>
            <td id="time2"></td>
            <td id="character2"></td>
            <td id="owner2"></td>
          </tr>
          <tr>
            <td id="time3"></td>
            <td id="character3"></td>
            <td id="owner3"></td>
          </tr>
          <tr>
            <td id="time4"></td>
            <td id="character4"></td>
            <td id="owner4"></td>
          </tr>
          <tr>
            <td id="time5"></td>
            <td id="character5"></td>
            <td id="owner5"></td>
          </tr>
          <tr>
            <td id="time6"></td>
            <td id="character6"></td>
            <td id="owner6"></td>
          </tr>
          <tr>
            <td id="time7"></td>
            <td id="character7"></td>
            <td id="owner7"></td>
          </tr>
          <tr>
            <td id="time8"></td>
            <td id="character8"></td>
            <td id="owner8"></td>
          </tr>
          <tr>
            <td id="time9"></td>
            <td id="character9"></td>
            <td id="owner9"></td>
          </tr>
        </table>

  </div>

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>

    <script>
      async function loadWeb3() {
        if (window.ethereum) {
          window.web3 = new Web3(window.ethereum);
          window.ethereum.enable();
        }
      }

      let currentAccount = null;
      window.ethereum
        .request({ method: "eth_accounts" })
        .then(handleAccountsChanged)
        .catch((err) => {
          console.error(err);
        });

      window.ethereum.on("accountsChanged", handleAccountsChanged);

      function handleAccountsChanged(accounts) {
        if (accounts.length === 0) {
          console.log("Please connect to MetaMask.");
        } else if (accounts[0] !== currentAccount) {
          currentAccount = accounts[0];
        }
      }

      let abi = 
      [
        {
          anonymous: false,
          inputs: [
          {
            indexed: false,
            internalType: "address",
            name: "owner",
            type: "address"
          },
          {
            indexed: false,
            internalType: "string",
            name: "character",
            type: "string"
          }
          ],
          name: "Add",
          type: "event"
        },
        {
          inputs: [
            {
              internalType: "string",
              name: "name",
              type: "string"
            }
          ],
          name: "buy",
          outputs: [],
          stateMutability: "payable",
          type: "function"
        }
      ];

      async function loadContract() {
        return await new window.web3.eth.Contract(
          abi,
          "0xd66233c69153470F4B90CA9766F4cFe49e461978"
        );
      }

      async function load() {
        await loadWeb3();
        window.contract = await loadContract();
        updateStatus("Ready!");
      }

      function updateStatus(status) {
        const statusEl = document.getElementById("status");
        statusEl.innerHTML = status;
        console.log(status);
      }

      var i = 0;

      function btnChoose(name, eth) {
        console.log(currentAccount);
        window.contract.methods
          .buy(name)
          .send({ from: currentAccount, value: eth }, function (error, result) {
            $("#result").html(result);
          });
        window.contract.once("Add", {}, function (error, event) {
          if (!error) {
            console.log(event);
            var h = new Date().getHours();
            var m = new Date().getMinutes();
            $("#result").html(
              "Name:" +
                event.returnValues.character +
                "<br/>time:" +
                h +
                ":" +
                m +
                "<br/>owner:" +
                event.returnValues.owner
            );
            i++;
            $("#time" + i).html(h + ":" + m);
            $("#character" + i).html(event.returnValues.character);
            $("#owner" + i).html(event.returnValues.owner);
          }
        });

        window.contract.once("RegistrationError", {}, function (error, event) {
          if (!error) {
            console.log(event);
            $("#result").html(
              "Error: " +
                event.returnValues.text +
                "<br/>Reason:" +
                event.returnValues.reason
            );
          }
        });
      }

      function timenow() {
        var s = new Date().toLocaleTimeString("en-US");
        console.log(s);
        return s;
      }
      load();
    </script>
  </body>
</html>